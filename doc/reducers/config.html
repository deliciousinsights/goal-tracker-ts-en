<!DOCTYPE html><html lang="en"><head><title>reducers/config</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../"><meta name="groc-document-path" content="reducers/config"><meta name="groc-project-path" content="src/reducers/config.ts"><link rel="stylesheet" type="text/css" media="all" href="../assets/style.css"><script type="text/javascript" src="../assets/behavior.js"></script><body><div id="meta"><div class="file-path">src/reducers/config.ts</div></div><div id="document"><div class="segment"><div class="comments "><div class="wrapper"><h1 id="quotsystemquot-config-for-the-app">&quot;System&quot; config for the app</h1>
<p>By listening to redux-persist&#39;s rehydration action, we can maintain a flag
about our app state being hydrated (or not yet), which enables our
<code>RehydrationWaiter</code> component.</p>
<p>We also handle notification permission management here, both for its initial
state (the API is available and we weren&#39;t blocked yet) and later requests
through a <a href="https://redux-toolkit.js.org/usage/usage-guide#async-requests-with-createasyncthunk">generic async
action</a>,
process through the middleware preconfigured by Redux Toolkit.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> { createAsyncThunk, createReducer } from <span class="hljs-string">'@reduxjs/toolkit'</span></div></div></div><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> ts</span></p>
<p>Redux-Persist apparently doesn&#39;t export types for its constants, soâ€¦</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">import</span> { REHYDRATE } from <span class="hljs-string">'redux-persist/constants'</span>

<span class="hljs-keyword">type</span> Config = {</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Should we prompt the user at all?</li>
</ul></div></div><div class="code"><div class="wrapper">  canPromptForNotify: <span class="hljs-built_in">boolean</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Do we have permission to notify?</li>
</ul></div></div><div class="code"><div class="wrapper">  canNotify: <span class="hljs-built_in">boolean</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><ul>
<li>Was the state hydrated by redux-persist already?</li>
</ul></div></div><div class="code"><div class="wrapper">  rehydrated: <span class="hljs-built_in">boolean</span>
}

<span class="hljs-keyword">const</span> bootNotificationPermission =
  (<span class="hljs-keyword">typeof</span> <span class="hljs-built_in">window</span> !== <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-built_in">window</span>.Notification?.permission) || <span class="hljs-string">'denied'</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="action-creators">Action Creators</h2></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>This is dispatched by the UI -see <code>TrackerScreen</code> and triggers the
notification permission prompt.  Chromium doesn&#39;t require it be triggered
from an interactive event, but Firefox obeys spec recommendations and does.</p></div></div><div class="code"><div class="wrapper"><span class="hljs-keyword">export</span> <span class="hljs-keyword">const</span> requestNotificationPermission = createAsyncThunk(
  <span class="hljs-string">'goal-tracker/config/requestNotificationPermission'</span>,</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>As our callback is async, any direct return of something other than a
promise is automatically wrapped as a fulfilled promise.</p></div></div><div class="code"><div class="wrapper">  async () =&gt; {
    <span class="hljs-keyword">if</span> (bootNotificationPermission === <span class="hljs-string">'denied'</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-string">'denied'</span>
    }</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>Leveraging system-based
<a href="https://developer.mozilla.org/fr/docs/Web/API/notification/Using_Web_Notifications">notifications</a>
isn&#39;t automatically allowed: the user must have granted us permission.
This function returns a promise to the resulting status, used following
the permission request action.</p></div></div><div class="code"><div class="wrapper">    <span class="hljs-keyword">return</span> <span class="hljs-built_in">window</span>.Notification.requestPermission()
  }
)</div></div></div><div class="segment"><div class="comments "><div class="wrapper"><h2 id="reducer">Reducer</h2></div></div></div><div class="segment"><div class="code"><div class="wrapper"><span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> createReducer&lt;Config&gt;(
  {
    canPromptForNotify: bootNotificationPermission === <span class="hljs-string">'default'</span>,
    canNotify: bootNotificationPermission === <span class="hljs-string">'granted'</span>,
    rehydrated: <span class="hljs-literal">false</span>,
  },
  (builder) =&gt; {
    builder
      .addCase(REHYDRATE, (state) =&gt; {
        state.rehydrated = <span class="hljs-literal">true</span>
      })
      .addCase(
        requestNotificationPermission.fulfilled,
        (state, { payload: status }) =&gt; {
          state.canPromptForNotify = status === <span class="hljs-string">'default'</span>
          state.canNotify = status === <span class="hljs-string">'granted'</span>
        }
      )
  }
)</div></div></div></div></body></html>